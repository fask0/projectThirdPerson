#include <iostream>
#include <vector>

#include "mge/materials/AbstractMaterial.hpp"
#include "mge/materials/LitDynamicGridTextureMaterial.hpp"

#include "mge/core/Level.hpp"
#include "mge/core/EnemySpawner.hpp"
#include "mge/core/Waypoint.hpp"
#include "mge/core/GameController.hpp"
#include "mge/core/CollisionManager.hpp"
#include "mge/core/GridManager.hpp"

#include "mge/behaviours/HealthBarBehaviour.hpp"
#include "mge/behaviours/MenuOnHoverBehaviour.hpp"
#include "mge/behaviours/SwitchSpriteOnHoverBehaviour.hpp"
#include "mge/behaviours/TowerIconBehaviour.hpp"

#include "glm.hpp"
#include "mge/config.hpp"

Level::Level(std::string pName, glm::vec3 pPosition, int pLayers)
	: GameObject(pName, pPosition), _layerAmount(pLayers)
{
	GameController::Levels.push_back(this);
}

Level::~Level()
{
}

void Level::update(float pStep)
{
	GameObject::update(pStep);
}

void Level::Init()
{
	_enemySpawnPoints.clear();
	_waypoints.clear();
	_layers.clear();
	GameController::GridObjects.clear();
<<<<<<< .merge_file_a12884
	GameController::MainCamera->setLocalPosition(glm::vec3(0, 15, 0));
	GameController::CameraBehaviour->SetBounds(_minX, _maxX, _minZ, _maxZ);
=======

	inintialize2Dobjects();

>>>>>>> .merge_file_a14036
	for (int i = 0; i < _layerAmount; ++i)
	{
		GameObject* o = new GameObject("layer" + std::to_string(i), glm::vec3(0, 0, 0));
		_layers.push_back(o);
	}

	for (int i = 0; i < _layers.size(); ++i)
	{
		_layers[i]->setMesh(Mesh::load(config::MGE_MODEL_PATH + "/Levels/" + _name + "/layer" + std::to_string(i)));

		if (i == 0)
		{
			LitDynamicTextureGridMaterial* mat = new LitDynamicTextureGridMaterial(GameController::Lights[0]);
			_layers[i]->setMaterial(mat);
			GameController::GridObjects.push_back(_layers[i]);
			GameController::MainPlane = _layers[i];
			GameController::MainPlaneMaterial = mat;
		}
		else
		{
			LitDynamicTextureGridMaterial* mat = new LitDynamicTextureGridMaterial(GameController::Lights[0], true);
			_layers[i]->setMaterial(mat);
		}

		if (_layers[i]->getMesh()->collidersInMesh.size() > 0)
		{
			for (auto &obj : _layers[i]->getMesh()->collidersInMesh)
			{
				if (dynamic_cast<EnemySpawner*>(obj))
					_enemySpawnPoints.push_back(dynamic_cast<EnemySpawner*>(obj));
				else if (dynamic_cast<Waypoint*>(obj))
					_waypoints.push_back(dynamic_cast<Waypoint*>(obj));

				this->add(obj);
			}
		}

		this->add(_layers[i]);
	}

	GridManager* gridManager = new GridManager(GameController::GridObjects, GameController::Window, this);
	this->add(gridManager);
	GameController::TowerDefenseScene->SetGridManager(gridManager);
}

void Level::reset()
{
	while (_children.size() > 0)
	{
		GameObject* child = _children[0];
		remove(child);
		delete child;
	}
	_parent->remove(this);
	CollisionManager::projectileCollisions.clear();
	CollisionManager::towerCollisions.clear();
	GameController::UIManager->_sprites.clear();
}

void Level::inintialize2Dobjects()
{
	//Load textures
	//Coin texture
	sf::Texture* coinIcon = new sf::Texture();
	coinIcon->loadFromFile(config::MGE_SPRITES_PATH + "coin.png");
	//Icon textures
	sf::Texture* menuIcon = new sf::Texture();
	menuIcon->loadFromFile(config::MGE_SPRITES_PATH + "menu_button.png");
	sf::Texture* menuIconSel = new sf::Texture();
	menuIconSel->loadFromFile(config::MGE_SPRITES_PATH + "menu_button_sel.png");
	sf::Texture* disgustingIcon = new sf::Texture();
	disgustingIcon->loadFromFile(config::MGE_SPRITES_PATH + "disgustingness.png");
	sf::Texture* toasterIcon = new sf::Texture();
	toasterIcon->loadFromFile(config::MGE_SPRITES_PATH + "toaster_icon_colour0.png");
	sf::Texture* toasterIconSel = new sf::Texture();
	toasterIconSel->loadFromFile(config::MGE_SPRITES_PATH + "toaster_icon_colour_sel0.png");
	sf::Texture* honeyIcon = new sf::Texture();
	honeyIcon->loadFromFile(config::MGE_SPRITES_PATH + "honey_icon_colour.png");
	sf::Texture* honeyIconSel = new sf::Texture();
	honeyIconSel->loadFromFile(config::MGE_SPRITES_PATH + "honey_icon_colour_sel.png");
	sf::Texture* iceIcon = new sf::Texture();
	iceIcon->loadFromFile(config::MGE_SPRITES_PATH + "ice_icon_colour.png");
	sf::Texture* iceIconSel = new sf::Texture();
	iceIconSel->loadFromFile(config::MGE_SPRITES_PATH + "ice_icon_sel.png");
	sf::Texture* batteryIcon = new sf::Texture();
	batteryIcon->loadFromFile(config::MGE_SPRITES_PATH + "battery_icon_colour.png");
	sf::Texture* batteryIconSel = new sf::Texture();
	batteryIconSel->loadFromFile(config::MGE_SPRITES_PATH + "battery_icon_sel.png");
	sf::Texture* magnifyingGlassIcon = new sf::Texture();
	magnifyingGlassIcon->loadFromFile(config::MGE_SPRITES_PATH + "magnifying_glass_colour.png");
	sf::Texture* magnifyingGlassIconSel = new sf::Texture();
	magnifyingGlassIconSel->loadFromFile(config::MGE_SPRITES_PATH + "magnifying_glass_sel.png");
	sf::Texture* sniperIcon = new sf::Texture();
	sniperIcon->loadFromFile(config::MGE_SPRITES_PATH + "peas_icon_colour.png");
	sf::Texture* sniperIconSel = new sf::Texture();
	sniperIconSel->loadFromFile(config::MGE_SPRITES_PATH + "peas_icon_sel.png");
	//Healthbar textures
	std::vector<sf::Texture*> healthBarSprites;
	sf::Texture* healthBarTexture0 = new sf::Texture();
	sf::Texture* healthBarTexture1 = new sf::Texture();
	sf::Texture* healthBarTexture2 = new sf::Texture();
	sf::Texture* healthBarTexture3 = new sf::Texture();
	sf::Texture* healthBarTexture4 = new sf::Texture();
	sf::Texture* healthBarTexture5 = new sf::Texture();
	sf::Texture* healthBarTexture6 = new sf::Texture();
	sf::Texture* healthBarTexture7 = new sf::Texture();
	sf::Texture* healthBarTexture8 = new sf::Texture();
	sf::Texture* healthBarTexture9 = new sf::Texture();
	healthBarTexture0->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar.png");
	healthBarTexture1->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar1.png");
	healthBarTexture2->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar2.png");
	healthBarTexture3->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar3.png");
	healthBarTexture4->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar4.png");
	healthBarTexture5->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar5.png");
	healthBarTexture6->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar6.png");
	healthBarTexture7->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar7.png");
	healthBarTexture8->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar8.png");
	healthBarTexture9->loadFromFile(config::MGE_SPRITES_PATH + "cheese_bar9.png");
	healthBarSprites.push_back(healthBarTexture9);
	healthBarSprites.push_back(healthBarTexture8);
	healthBarSprites.push_back(healthBarTexture7);
	healthBarSprites.push_back(healthBarTexture6);
	healthBarSprites.push_back(healthBarTexture5);
	healthBarSprites.push_back(healthBarTexture4);
	healthBarSprites.push_back(healthBarTexture3);
	healthBarSprites.push_back(healthBarTexture2);
	healthBarSprites.push_back(healthBarTexture1);
	//Description textures
	sf::Texture* toasterDescription = new sf::Texture();
	sf::Texture* honeyDescription = new sf::Texture();
	sf::Texture* iceDescription = new sf::Texture();
	sf::Texture* magnifyingGlassDescription = new sf::Texture();
	sf::Texture* sniperDescription = new sf::Texture();
	sf::Texture* batteryDescription = new sf::Texture();
	toasterDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/toaster_description.png");
	honeyDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/honey_description.png");
	iceDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/ice_description.png");
	magnifyingGlassDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/magnifying_glass_description.png");
	sniperDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/sniper_description.png");
	batteryDescription->loadFromFile(config::MGE_SPRITES_PATH + "descriptions/battery_description.png");

	//------//
	// Coin //
	//------//
	AdvancedSprite* coin = new AdvancedSprite(coinIcon);
	coin->setPosition(GameController::Window->getSize().x - coinIcon->getSize().x - 172, GameController::Window->getSize().y - coinIcon->getSize().y - 80);
	sf::Text* coinsText = new sf::Text();
	sf::Font font = sf::Font();
	font.loadFromFile(config::MGE_SPRITES_PATH + "CREABBB_.TTF");
	coinsText->setFillColor(sf::Color::White);
	coinsText->setPosition(GameController::Window->getSize().x - 164, GameController::Window->getSize().y - coinIcon->getSize().y - 80);
	coinsText->setFont(font);

	//------------//
	// Health Bar //
	//------------//
	AdvancedSprite* healthBar = new AdvancedSprite(healthBarTexture0);
	healthBar->setPosition(GameController::Window->getSize().x - healthBarTexture0->getSize().x - 64, GameController::Window->getSize().y - healthBarTexture0->getSize().y - 96 - coinIcon->getSize().y - 8);
	healthBar->addBehaviour(new HealthBarBehaviour(healthBarSprites));

	//-------------//
	// Tower Icons //
	//-------------//
	std::vector<AdvancedSprite*> menuSprites;
	AdvancedSprite* menuSprite = new AdvancedSprite(menuIcon);
	menuSprite->setPosition(64, GameController::Window->getSize().y - menuIcon->getSize().y - 64);
	menuSprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(menuIconSel));
	AdvancedSprite* toasterSprite = new AdvancedSprite(toasterIcon);
	toasterSprite->setPosition(64 + toasterIcon->getSize().x, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	toasterSprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(toasterIconSel));
	toasterSprite->addBehaviour(new TowerIconBehaviour(1, toasterDescription));
	menuSprites.push_back(toasterSprite);
	AdvancedSprite* honeySprite = new AdvancedSprite(honeyIcon);
	honeySprite->setPosition(64 + toasterIcon->getSize().x * 2, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	honeySprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(honeyIconSel));
	honeySprite->addBehaviour(new TowerIconBehaviour(2, honeyDescription));
	menuSprites.push_back(honeySprite);
	AdvancedSprite* iceSprite = new AdvancedSprite(iceIcon);
	iceSprite->setPosition(64 + toasterIcon->getSize().x * 3, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	iceSprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(iceIconSel));
	iceSprite->addBehaviour(new TowerIconBehaviour(4, iceDescription));
	menuSprites.push_back(iceSprite);
	AdvancedSprite* batterySprite = new AdvancedSprite(batteryIcon);
	batterySprite->setPosition(64 + toasterIcon->getSize().x * 4, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	batterySprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(batteryIconSel));
	batterySprite->addBehaviour(new TowerIconBehaviour(3, batteryDescription));
	menuSprites.push_back(batterySprite);
	AdvancedSprite* magnifyingGlassSprite = new AdvancedSprite(magnifyingGlassIcon);
	magnifyingGlassSprite->setPosition(64 + toasterIcon->getSize().x * 5, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	magnifyingGlassSprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(magnifyingGlassIconSel));
	magnifyingGlassSprite->addBehaviour(new TowerIconBehaviour(5, magnifyingGlassDescription));
	menuSprites.push_back(magnifyingGlassSprite);
	AdvancedSprite* sniperSprite = new AdvancedSprite(sniperIcon);
	sniperSprite->setPosition(64 + toasterIcon->getSize().x * 6, GameController::Window->getSize().y - toasterIcon->getSize().y - 64 - ((menuIcon->getSize().y - toasterIcon->getSize().y) / 2));
	sniperSprite->addBehaviour(new SwitchSpriteOnHoverBehaviour(sniperIconSel));
	sniperSprite->addBehaviour(new TowerIconBehaviour(6, sniperDescription));
	menuSprites.push_back(sniperSprite);
	menuSprite->addBehaviour(new MenuOnHoverBehaviour(menuSprites));

	//Add sprites to world and UImanager
	//CoinF

	this->add(coin);
	GameController::UIManager->AddSprite(coin);
	//Healthbar
	this->add(healthBar);
	GameController::UIManager->AddSprite(healthBar);
	//Icons
	this->add(menuSprite);
	this->add(magnifyingGlassSprite);
	this->add(sniperSprite);
	this->add(toasterSprite);
	this->add(honeySprite);
	this->add(iceSprite);
	this->add(batterySprite);
	GameController::UIManager->AddSprite(sniperSprite);
	GameController::UIManager->AddSprite(magnifyingGlassSprite);
	GameController::UIManager->AddSprite(iceSprite);
	GameController::UIManager->AddSprite(batterySprite);
	GameController::UIManager->AddSprite(honeySprite);
	GameController::UIManager->AddSprite(toasterSprite);
	GameController::UIManager->AddSprite(menuSprite);
	//Texts
	GameController::UIManager->AddText(coinsText);
}
